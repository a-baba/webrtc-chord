/**
* @license almond 0.2.9 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
* Available via the MIT or new BSD license.
* see: http://github.com/jrburke/almond for details
*/

(function(e,t){typeof define=="function"&&define.amd?define([],t):e.Chord=t()})(this,function(){var e,t,n;return function(r){function v(e,t){return h.call(e,t)}function m(e,t){var n,r,i,s,o,u,a,f,c,h,p,v=t&&t.split("/"),m=l.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){v=v.slice(0,v.length-1),e=e.split("/"),o=e.length-1,l.nodeIdCompat&&d.test(e[o])&&(e[o]=e[o].replace(d,"")),e=v.concat(e);for(c=0;c<e.length;c+=1){p=e[c];if(p===".")e.splice(c,1),c-=1;else if(p===".."){if(c===1&&(e[2]===".."||e[0]===".."))break;c>0&&(e.splice(c-1,2),c-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(c=n.length;c>0;c-=1){r=n.slice(0,c).join("/");if(v)for(h=v.length;h>0;h-=1){i=m[v.slice(0,h).join("/")];if(i){i=i[r];if(i){s=i,u=c;break}}}if(s)break;!a&&g&&g[r]&&(a=g[r],f=c)}!s&&a&&(s=a,u=f),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function g(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function y(e){return function(t){return m(t,e)}}function b(e){return function(t){a[e]=t}}function w(e){if(v(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!v(a,e)&&!v(c,e))throw new Error("No "+e);return a[e]}function E(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice,d=/\.js$/;o=function(e,t){var n,r=E(e),i=r[0];return e=r[1],i&&(i=m(i,t),n=w(i)),i?n&&n.normalize?e=n.normalize(e,y(t)):e=m(e,t):(e=m(e,t),r=E(e),i=r[0],e=r[1],i&&(n=w(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return g(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:S(e)}}},i=function(e,t,n,i){var s,l,h,p,d,m=[],y=typeof n,E;i=i||e;if(y==="undefined"||y==="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(d=0;d<t.length;d+=1){p=o(t[d],i),l=p.f;if(l==="require")m[d]=u.require(e);else if(l==="exports")m[d]=u.exports(e),E=!0;else if(l==="module")s=m[d]=u.module(e);else if(v(a,l)||v(f,l)||v(c,l))m[d]=w(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,g(i,!0),b(l),{}),m[d]=a[l]}}h=n?n.apply(a[e],m):undefined;if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!E)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){if(typeof e=="string")return u[e]?u[e](t):w(o(e,t).f);if(!e.splice){l=e,l.deps&&s(l.deps,l.callback);if(!t)return;t.splice?(e=t,t=n,n=null):e=r}return t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s},s.config=function(e){return s(e)},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!v(a,e)&&!v(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("lib/almond",function(){}),n("lodash",[],function(){return _}),n("cryptojs",[],function(){return CryptoJS}),n("Utils",["lodash"],function(e){var t={version:[1,0,0],isNonemptyString:function(t){return e.isString(t)&&!e.isEmpty(t)},isValidNumber:function(t){return!e.isNaN(t)&&e.isNumber(t)},isPositiveNumber:function(e){return t.isValidNumber(e)&&e>0},isZeroOrPositiveNumber:function(e){return e===0||t.isPositiveNumber(e)},insert:function(e,t,n){e.splice(t,0,n)},generateRandomId:function(e){var t="";while(t.length<e)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},enableDebugLog:function(e){t.debug=function(){if(e){var t=Array.prototype.slice.call(arguments),n=new Date,r=[n.getHours(),n.getMinutes(),n.getSeconds()].join(":")+":";t.unshift(r),console.log.apply(console,t)}}},debug:function(){}},n=function(t,n){var r=this;this._items=[],this._comparator=n,e.each(t,function(e){r.put(e)})};n.prototype={put:function(e){(this.size()===0||!this.has(e))&&this._items.push(e)},remove:function(t){var n=this;this._items=e.reject(this._items,function(e){return n._comparator(e,t)})},size:function(){return e.size(this._items)},has:function(t){var n=this;return e.some(this._items,function(e){return n._comparator(e,t)})},items:function(){return this._items}},t.Set=n;var r=function(){this._items=[]};r.prototype={enqueue:function(e){this._items.push(e)},dequeue:function(){return e.isEmpty(this._items)?null:this._items.shift()},first:function(){return e.isEmpty(this._items)?null:e.first(this._items)},last:function(){return e.isEmpty(this._items)?null:e.last(this._items)},size:function(){return e.size(this._items)}},t.Queue=r;var i=function(e,t){this._cache={},this._useHistory=[],this._capacity=e,this._cacheOutCallback=t};return i.prototype={get:function(t){return e.has(this._cache,t)?(this._updateUseHistory(t),this._cache[t]):null},set:function(t,n){var r=this;this._cache[t]=n,this._updateUseHistory(t);if(e.size(this._cache)>this._capacity){var i=e.rest(this._useHistory,this._capacity);this._useHistory=e.first(this._useHistory,this._capacity),e.each(i,function(e){var t=r._cache[e];delete r._cache[e],r._cacheOutCallback(t)})}},remove:function(t){if(!this.has(t))return;this._useHistory=e.reject(this._useHistory,function(e){return e===t}),delete this._cache[t]},has:function(t){return e.has(this._cache,t)},keys:function(){return e.keys(this._cache)},_updateUseHistory:function(t){this._useHistory=e.reject(this._useHistory,function(e){return e===t}),this._useHistory.unshift(t)}},t.Cache=i,t}),n("ID",["lodash","cryptojs","Utils"],function(e,t,n){var r=function(t){e.each(t,function(t){if(e.isNaN(t)||!e.isNumber(t)||t<0||255<t)throw new Error("Invalid argument.")});if(t.length!==r._BYTE_SIZE)throw new Error("Invalid argument.");this._bytes=e.last(t,r._BYTE_SIZE),this._hexString=e.map(this._bytes,function(e){var t=e.toString(16);return e<16?"0"+t:t}).join("")};return r._BYTE_SIZE=32,r._BIT_LENGTH=r._BYTE_SIZE*8,r.create=function(e){if(!n.isNonemptyString(e))throw new Error("Invalid argument.");return new r(r._createBytes(e))},r._createBytes=function(e){var n=t.SHA256(e).toString(t.enc.Hex);return r._createBytesFromHexString(n)},r._createBytesFromHexString=function(t){if(!n.isNonemptyString(t)||t.length<r._BYTE_SIZE*2)throw new Error("Invalid argument.");return e(r._BYTE_SIZE).times(function(e){return parseInt(t.substr(e*2,2),16)}).value()},r.fromHexString=function(e){return new r(r._createBytesFromHexString(e))},r._addInBytes=function(t,n){var r=e.clone(t),i=0;for(var s=t.length-1;s>=0;s--)r[s]+=n[s]+i,r[s]<0?(i=-1,r[s]+=256):i=r[s]>>8,r[s]&=255;return r},r.prototype={isInInterval:function(e,t){if(!e||!t)throw new Error("Invalid arguments.");return e.equals(t)?!this.equals(e):e.compareTo(t)<0?this.compareTo(e)>0&&this.compareTo(t)<0:this.compareTo(e)>0||this.compareTo(t)<0},addPowerOfTwo:function(t){if(t<0||t>=r._BIT_LENGTH)throw new Error("Power of two out of index.");var n=e.clone(this._bytes),i=this._bytes.length-1-Math.floor(t/8),s=[1,2,4,8,16,32,64,128][t%8];for(var o=i;o>=0;o--){n[o]+=s,s=n[o]>>8,n[o]&=255;if(s===0)break}return new r(n)},add:function(e){return new r(r._addInBytes(this._bytes,e._bytes))},sub:function(t){return new r(r._addInBytes(this._bytes,e.map(t._bytes,function(e){return-e})))},getIntervalInPowerOfTwoFrom:function(e){if(this.equals(e))return-Infinity;var t=this.sub(e);for(var n=0;n<r._BIT_LENGTH;n++)if(r._powerOfTwos[n].compareTo(t)>0){if(n===0)return-Infinity;break}return n-1},compareTo:function(e){for(var t=0;t<r._BYTE_SIZE;t++){if(this._bytes[t]<e._bytes[t])return-1;if(this._bytes[t]>e._bytes[t])return 1}return 0},equals:function(e){return this.compareTo(e)===0},getLength:function(){return r._BIT_LENGTH},toHexString:function(){return this._hexString}},r.minId=new r(e(r._BYTE_SIZE).times(function(){return 0}).value()),r.maxId=new r(e(r._BYTE_SIZE).times(function(){return 255}).value()),r._powerOfTwos=e(r.minId.getLength()).times(function(e){return r.minId.addPowerOfTwo(e)}).value(),r}),n("Response",["lodash","Utils"],function(e,t){var n=function(n,r,i,s,o,u){if(n[0]!==t.version[0])throw new Error("Cannot communicate with version "+n.join(".")+" (your version is "+t.version.join(".")+")");if(!t.isNonemptyString(r)||!t.isNonemptyString(i)||!e.isObject(s)||!t.isNonemptyString(o)||!e.isNumber(u))throw new Error("Invalid argument.");this.version=n,this.status=r,this.method=i,this.result=s,this.requestId=o,this.timestamp=u};return n.create=function(r,i,s){return new n(t.version,r,s.method,i,s.requestId,e.now())},n.isResponse=function(n){return e.isObject(n)?t.isNonemptyString(n.status)?!0:!1:!1},n.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new n(t.version,t.status,t.method,t.result,t.requestId,t.timestamp)},n.prototype={toJson:function(){return{version:this.version,status:this.status,method:this.method,result:this.result,requestId:this.requestId,timestamp:this.timestamp}}},n}),n("Request",["lodash","cryptojs","Response","Utils"],function(e,t,n,r){var i=function(t,n,i,s,o){if(t[0]!==r.version[0])throw new Error("Cannot communicate with version "+t.join(".")+" (your version is "+r.version.join(".")+")");if(!r.isNonemptyString(n)||!e.isObject(i)||!r.isNonemptyString(s)||!e.isNumber(o))throw new Error("Invalid argument.");this.version=t,this.method=n,this.params=i,this.requestId=s,this.timestamp=o};return i.create=function(t,n){return new i(r.version,t,n,r.generateRandomId(8),e.now())},i.isRequest=function(e){return!n.isResponse(e)},i.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new i(t.version,t.method,t.params,t.requestId,t.timestamp)},i.prototype={toJson:function(){return{version:this.version,method:this.method,params:this.params,requestId:this.requestId,timestamp:this.timestamp}}},i}),n("Entry",["lodash","ID"],function(e,t){var n=function(t,n){if(e.isNull(t)||e.isUndefined(n))throw new Error("Invalid argument.");this.id=t,this.value=n};return n.fromJson=function(r){if(!e.isObject(r))throw new Error("invalid argument.");return new n(t.fromHexString(r.id),r.value)},n.prototype={equals:function(t){return t instanceof n?this.id.equals(t.id)&&e.isEqual(this.value,t.value):!1},toJson:function(){return{id:this.id.toHexString(),value:this.value}}},n}),n("Node",["lodash","ID","Request","Entry","Utils"],function(e,t,n,r,i){var s=function(e,n,r,o,u){if(!s.isValidNodeInfo(e))throw new Error("Invalid arguments.");i.isZeroOrPositiveNumber(u.requestTimeout)||(u.requestTimeout=18e4),this._peerId=e.peerId,this.nodeId=t.create(e.peerId),this._nodeFactory=n,this._connectionFactory=r,this._requestHandler=o,this._config=u};return s.isValidNodeInfo=function(t){return e.isObject(t)?i.isNonemptyString(t.peerId)?!0:!1:!1},s.prototype={findSuccessor:function(e,n){var r=this;if(!(e instanceof t)){n(null);return}this._sendRequest("FIND_SUCCESSOR",{key:e.toHexString()},{success:function(e){var t=e.successorNodeInfo;r._nodeFactory.create(t,n)},redirect:function(t){r._nodeFactory.create(t.redirectNodeInfo,function(t,r){if(r){n(null,r);return}i.debug("[findSuccessor] redirected to "+t.getPeerId()),t.findSuccessor(e,n)})},error:function(e){n(null,e)}})},notifyAndCopyEntries:function(t,n){var i=this;this._sendRequest("NOTIFY_AND_COPY",{potentialPredecessorNodeInfo:t.toNodeInfo()},{success:function(t){if(!e.isArray(t.referencesNodeInfo)||!e.isArray(t.entries)){n(null,null);return}i._nodeFactory.createAll(t.referencesNodeInfo,function(i){var s=e.chain(t.entries).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();n(i,s)})},error:function(e){n(null,null,e)}})},notify:function(t,n){var r=this;this._sendRequest("NOTIFY",{potentialPredecessorNodeInfo:t.toNodeInfo()},{success:function(t){if(!e.isArray(t.referencesNodeInfo)){n(null);return}r._nodeFactory.createAll(t.referencesNodeInfo,function(e){n(e)})},error:function(e){n(null,e)}})},leavesNetwork:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");this._sendRequest("LEAVES_NETWORK",{predecessorNodeInfo:t.toNodeInfo()})},ping:function(e){this._sendRequest("PING",{},{success:function(t){e()},error:function(t){e(t)}})},insertReplicas:function(t){this._sendRequest("INSERT_REPLICAS",{replicas:e.invoke(t,"toJson")})},removeReplicas:function(t,n){this._sendRequest("REMOVE_REPLICAS",{sendingNodeId:t.toHexString(),replicas:e.invoke(n,"toJson")})},insertEntry:function(e,t){var n=this;this._sendRequest("INSERT_ENTRY",{entry:e.toJson()},{success:function(e){t()},redirect:function(r){n._nodeFactory.create(r.redirectNodeInfo,function(n,r){if(r){t(r);return}i.debug("[insertEntry] redirected to "+n.getPeerId()),n.insertEntry(e,t)})},error:function(e){t(e)}})},retrieveEntries:function(t,n){var s=this;this._sendRequest("RETRIEVE_ENTRIES",{id:t.toHexString()},{success:function(t){if(!e.isArray(t.entries)){n(null,new Error("Received invalid data from "+s._peerId));return}var i=e.chain(t.entries).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();n(i)},redirect:function(e){s._nodeFactory.create(e.redirectNodeInfo,function(e,r){if(r){n(null,r);return}i.debug("[retrieveEntries] redirected to "+e.getPeerId()),e.retrieveEntries(t,n)})},error:function(e){n(null,e)}})},removeEntry:function(e,t){var n=this;this._sendRequest("REMOVE_ENTRY",{entry:e.toJson()},{success:function(e){t()},redirect:function(r){n._nodeFactory.create(r.redirectNodeInfo,function(n,r){if(r){t(r);return}i.debug("[removeEntry] redirected to "+n.getPeerId()),n.removeEntry(e,t)})},error:function(e){t(e)}})},_sendRequest:function(t,r,s){var o=this;this._connectionFactory.create(this._peerId,function(u,a){if(a){s&&s.error&&s.error(a);return}var f=n.create(t,r);if(s){s=e.defaults(s,{success:function(){},redirect:function(){},error:function(){}});var l=setTimeout(function(){o._nodeFactory.deregisterCallback(f.requestId),s.error(new Error(t+" request to "+o._peerId+" timed out."))},o._config.requestTimeout);o._nodeFactory.registerCallback(f.requestId,e.once(function(e){clearTimeout(l);switch(e.status){case"SUCCESS":s.success(e.result);break;case"REDIRECT":s.redirect(e.result);break;case"FAILED":s.error(new Error("Request to "+o._peerId+" failed: "+e.result.message));break;default:callback.error(new Error("Received unknown status response:",e.status))}}))}i.debug("Sending request to",o._peerId,":",f.method);try{u.send(f)}finally{u.close()}})},onRequestReceived:function(e){var t=this;i.debug("Received request from",this._peerId,":",e.method),this._requestHandler.handle(e,function(e){t._connectionFactory.create(t._peerId,function(n,r){if(r){console.log(r);return}i.debug("Sending response to",t._peerId,":",e.method);try{n.send(e)}finally{n.close()}})})},onResponseReceived:function(t){i.debug("Received response from",this._peerId,":",t.method,"(",t.status,")");var n=this._nodeFactory.deregisterCallback(t.requestId);e.isNull(n)||n(t)},disconnect:function(){this._connectionFactory.removeConnection(this._peerId)},getPeerId:function(){return this._peerId},toNodeInfo:function(){return{nodeId:this.nodeId.toHexString(),peerId:this._peerId}},equals:function(t){return e.isNull(t)?!1:this.nodeId.equals(t.nodeId)},toString:function(){return this.nodeId.toHexString()+" ("+this._peerId+")"}},s}),n("peerjs",[],function(){return Peer}),n("PeerAgent",["lodash","peerjs","Utils"],function(e,t,n){var r=function(r,i){var s=this;e.isObject(r.peer)||(r.peer={id:undefined,options:{}}),e.isObject(r.peer.options)||(r.peer.options={}),n.isZeroOrPositiveNumber(r.connectRateLimit)||(r.connectRateLimit=3e3),n.isZeroOrPositiveNumber(r.connectionOpenTimeout)||(r.connectionOpenTimeout=3e4),e.isString(r.peer.id)?this._peer=new t(r.peer.id,r.peer.options):this._peer=new t(r.peer.options),this._config=r,this._callbacks=i,this._waitingTimer=null;var o=e.once(i.onPeerSetup);this._peer.on("open",function(e){n.debug("Peer opend (peer ID:",e,")"),s._peer.on("connection",function(e){n.debug("Connection from",e.peer),e.on("open",function(){i.onConnection(e.peer,e)})}),s._peer.on("close",function(){n.debug("Peer closed."),i.onPeerClosed()}),o(e)}),this._peer.on("error",function(e){n.debug("Peer error:",e);var t=e.message.match(/Could not connect to peer (\w+)/);if(t){if(!s.isWaitingForOpeningConnection())return;clearTimeout(s._waitingTimer),s._waitingTimer=null;var r=t[1];i.onConnectionOpened(r,null,e);return}console.log(e),o(null,e)})};return r.prototype={connect:function(e){var t=this;if(this.isWaitingForOpeningConnection())throw new Error("Invalid state.");var r=this._peer.connect(e,{serialization:"json"});if(!r){var i=new Error("Failed to open connection to "+e+".");this._callbacks.onConnectionOpened(e,null,i);return}this._waitingTimer=setTimeout(function(){if(!t.isWaitingForOpeningConnection())return;t._waitingTimer=null;var n=new Error("Opening connection to "+e+" timed out.");t._callbacks.onConnectionOpened(e,null,n)},this._config.connectionOpenTimeout),r.on("open",function(){n.debug("Connection to",r.peer,"opened.");if(!t.isWaitingForOpeningConnection()){console.log("Unexpected opening connection."),r.close();return}clearTimeout(t._waitingTimer),t._waitingTimer=null,t._callbacks.onConnectionOpened(e,r)})},isWaitingForOpeningConnection:function(){return!e.isNull(this._waitingTimer)},destroy:function(){this._peer.destroy()},getPeerId:function(){return this._peer.id}},r}),n("Packet",["lodash","cryptojs","Utils"],function(e,t,n){var r=function(t,r,i){if(!n.isNonemptyString(t)||!e.isObject(r)||!e.isObject(i))throw new Error("Invalid argument.");this.id=t,this.flags=r,this.payload=i};return r.create=function(e,t){return new r(n.generateRandomId(8),e,t)},r.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new r(t.id,t.flags,t.payload)},r.prototype={toJson:function(){return{id:this.id,flags:this.flags,payload:this.payload}}},r}),n("Connection",["lodash","Request","Response","Packet","Utils"],function(e,t,n,r,i){var s=function(e,t,n){var s=this;i.isZeroOrPositiveNumber(n.connectionCloseDelay)||(n.connectionCloseDelay=3e4),this._conn=e,this._callbacks=t,this._config=n,this._shutdown=!1,this._conn.on("data",function(e){var n;try{n=r.fromJson(e)}catch(i){console.error(i);return}if(n.flags.FIN){s._shutdown=!0,t.receivedFin(s);return}s._onDataReceived(n.payload)}),this._conn.on("close",function(){s._shutdown=!0,t.closedByRemote(s)}),this._conn.on("error",function(e){console.log(e)})};return s.prototype={send:function(e,t){var n=r.create({},e.toJson());if(!this.isAvailable())throw new Error("Connection is not available.");this._conn.send(n.toJson())},_onDataReceived:function(e){var r=this;if(n.isResponse(e)){var i;try{i=n.fromJson(e)}catch(s){console.log(s);return}this._callbacks.responseReceived(this,i)}else if(t.isRequest(e)){var o;try{o=t.fromJson(e)}catch(s){console.log(s);return}this._callbacks.requestReceived(this,o)}},close:function(){this._callbacks.closedByLocal(this)},shutdown:function(){var t=this;if(this.isAvailable()){var n=r.create({FIN:!0},{});this._conn.send(n.toJson())}this._shutdown=!0,e.delay(function(){t._conn.close()},this._config.connectionCloseDelay)},getPeerId:function(){return this._conn.peer},isAvailable:function(){return!this._shutdown&&this._conn.open}},s}),n("ConnectionFactory",["lodash","PeerAgent","Connection","Utils"],function(e,t,n,r){var i=function(i,s,o){var u=this,a={requestReceived:function(e,t){e.isAvailable()?u._connectionPool.set(e.getPeerId(),e):e.shutdown(),s.onRequestReceived(e.getPeerId(),t)},responseReceived:function(e,t){e.isAvailable()?u._connectionPool.set(e.getPeerId(),e):e.shutdown(),s.onResponseReceived(e.getPeerId(),t)},closedByRemote:function(e){u.removeConnection(e.getPeerId())},closedByLocal:function(e){e.isAvailable()?u._connectionPool.set(e.getPeerId(),e):e.shutdown()},receivedFin:function(e){a.closedByRemote(e)}};this._peerAgent=new t(i,{onPeerSetup:function(e,t){if(t){o(null,t);return}o(u)},onConnectionOpened:function(e,t,r){if(r){u._invokeNextCallback(e,null,r);return}var s=new n(t,a,i);u._invokeNextCallback(e,s)},onConnection:function(t,r){u._connectionPool.has(t)&&u.removeConnection(t);var s,o=setTimeout(function(){s.shutdown()},i.silentConnectionCloseTimeout),f=e.once(function(){clearTimeout(o)});s=new n(r,e.defaults({requestReceived:function(e,t){f(),a.requestReceived(e,t)},responseReceived:function(e,t){f(),a.responseReceived(e,t)}},a),i)},onPeerClosed:function(){e.each(u._connectionPool.keys(),function(e){u.removeConnection(e)})}}),r.isZeroOrPositiveNumber(i.connectionPoolSize)||(i.connectionPoolSize=10),r.isZeroOrPositiveNumber(i.silentConnectionCloseTimeout)||(i.silentConnectionCloseTimeout=3e4),this._connectionPool=new r.Cache(i.connectionPoolSize,function(e){e.shutdown()}),this._callbackQueue=new r.Queue};return i.create=function(e,t,n){var r=new i(e,t,n)},i.prototype={create:function(e,t){var n=this;if(!r.isNonemptyString(e)){t(null);return}this._callbackQueue.enqueue({peerId:e,callback:t}),this._createConnectionAndInvokeNextCallback()},_createConnectionAndInvokeNextCallback:function(){var t=this,n=this._callbackQueue.first();if(e.isNull(n))return;if(this._peerAgent.isWaitingForOpeningConnection())return;if(this._connectionPool.has(n.peerId)){var r=this._connectionPool.get(n.peerId);if(r.isAvailable()){this._invokeNextCallback(r.getPeerId(),r);return}this.removeConnection(r.getPeerId())}this._peerAgent.connect(n.peerId)},_invokeNextCallback:function(t,n,r){var i=this;e.defer(function(){i._createConnectionAndInvokeNextCallback()});var s=this._callbackQueue.dequeue();if(e.isNull(s)){console.log("Unknown situation.");return}if(s.peerId!==t){s.callback(null,new Error("Unknown situation."));return}s.callback(n,r)},removeConnection:function(t){var n=this._connectionPool.get(t);if(e.isNull(n))return;this._connectionPool.remove(t),n.shutdown()},destroy:function(){this._peerAgent.destroy()},getPeerId:function(){return this._peerAgent.getPeerId()}},i}),n("RequestHandler",["lodash","ID","Response","Entry","Utils"],function(e,t,n,r,i){var s=function(e,t){this._localNode=e,this._nodeFactory=t};return s.prototype={handle:function(n,s){var o=this;switch(n.method){case"FIND_SUCCESSOR":if(!i.isNonemptyString(n.params.key)){this._sendFailureResponse("Invalid params.",n,s);return}var u=t.fromHexString(n.params.key);this._localNode.findSuccessorIterative(u,function(e,t,r){if(r){console.log(r),o._sendFailureResponse(c.message,n,s);return}e==="SUCCESS"?o._sendSuccessResponse({successorNodeInfo:t.toNodeInfo()},n,s):e==="REDIRECT"&&o._sendRedirectResponse({redirectNodeInfo:t.toNodeInfo()},n,s)});break;case"NOTIFY_AND_COPY":var a=n.params.potentialPredecessorNodeInfo;this._nodeFactory.create(a,function(t,r){if(r){console.log(r),this._sendFailureResponse(c.message,n,s);return}o._localNode.notifyAndCopyEntries(t,function(t,r){if(e.isNull(t)||e.isNull(r)){o._sendFailureResponse("Unknown error.",n,s);return}o._sendSuccessResponse({referencesNodeInfo:e.invoke(t,"toNodeInfo"),entries:e.invoke(r,"toJson")},n,s)})});break;case"NOTIFY":var a=n.params.potentialPredecessorNodeInfo;this._nodeFactory.create(a,function(t,r){if(r){console.log(r),o._sendFailureResponse(c.message,n,s);return}o._localNode.notify(t,function(t){if(e.isNull(t)){o._sendFailureResponse("Unknown error.",n,s);return}o._sendSuccessResponse({referencesNodeInfo:e.invoke(t,"toNodeInfo")},n,s)})});break;case"PING":o._sendSuccessResponse({},n,s);break;case"INSERT_REPLICAS":if(!e.isArray(n.params.replicas))return;var f=e.chain(n.params.replicas).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();o._localNode.insertReplicas(f);break;case"REMOVE_REPLICAS":var l;try{l=t.fromHexString(n.params.sendingNodeId)}catch(c){return}if(!e.isArray(n.params.replicas))return;var f=e.chain(n.params.replicas).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();o._localNode.removeReplicas(l,f);break;case"INSERT_ENTRY":var h;try{h=r.fromJson(n.params.entry)}catch(c){o._sendFailureResponse(c.message,n,s);return}o._localNode.insertEntryIterative(h,function(e,t,r){if(r){console.log("Failed to insert entry:",r),o._sendFailureResponse("Unknown error.",n,s);return}e==="SUCCESS"?o._sendSuccessResponse({},n,s):e==="REDIRECT"&&o._sendRedirectResponse({redirectNodeInfo:t.toNodeInfo()},n,s)});break;case"RETRIEVE_ENTRIES":var p;try{p=t.fromHexString(n.params.id)}catch(c){o._sendFailureResponse(c.message,n,s);return}o._localNode.retrieveEntriesIterative(p,function(t,r,i,u){if(u){console.log("Failed to retrieve entries:",u),o._sendFailureResponse("Unknown error.",n,s);return}t==="SUCCESS"?o._sendSuccessResponse({entries:e.invoke(r,"toJson")},n,s):t==="REDIRECT"&&o._sendRedirectResponse({redirectNodeInfo:i.toNodeInfo()},n,s)});break;case"REMOVE_ENTRY":var h;try{h=r.fromJson(n.params.entry)}catch(c){o._sendFailureResponse(c.message,n,s);return}o._localNode.removeEntryIterative(h,function(e,t,r){if(r){console.log("Failed to remove entry:",r),o._sendFailureResponse("Unknown error.",n,s);return}e==="SUCCESS"?o._sendSuccessResponse({},n,s):e==="REDIRECT"&&o._sendRedirectResponse({redirectNodeInfo:t.toNodeInfo()},n,s)});break;case"SHUTDOWN":break;case"LEAVES_NETWORK":var d=n.params.predecessorNodeInfo;this._nodeFactory.create(d,function(e,t){if(t){console.log(t);return}o._localNode.leavesNetwork(e)});break;default:this._sendFailureResponse("Unknown request method type.",n,s)}},_sendSuccessResponse:function(e,t,n){this._sendResponse("SUCCESS",e,t,n)},_sendRedirectResponse:function(e,t,n){this._sendResponse("REDIRECT",e,t,n)},_sendResponse:function(e,t,r,i){var s=this,o;try{o=n.create(e,t,r)}catch(u){this._sendFailureResponse(u.message,r,i);return}i(o)},_sendFailureResponse:function(e,t,r){var i;try{i=n.create("FAILED",{message:e},t)}catch(s){return}r(i)}},s}),n("NodeFactory",["lodash","Node","ConnectionFactory","RequestHandler","ID","Utils"],function(e,t,n,r,i,s){var o=function(t,n){var i=this;if(e.isNull(t))throw new Error("Invalid arguments.");this._localNode=t,this._config=n,this._connectionFactory=null,this._requestHandler=new r(t,this),this._callbacks={}};return o.create=function(t,r,i){e.isNull(t)&&i(null,null);var s=new o(t,r);n.create(r,s,function(e,t){if(t){i(null,null,t);return}s._connectionFactory=e,i(e.getPeerId(),s)})},o.prototype={create:function(e,n){var r=this;if(!t.isValidNodeInfo(e)){n(null,new Error("Invalid node info."));return}if(this._localNode.nodeId.equals(i.create(e.peerId))){n(this._localNode);return}var s=new t(e,this,this._connectionFactory,this._requestHandler,this._config);n(s)},createAll:function(t,n){var r=this;if(e.isEmpty(t)){n([]);return}this.create(e.first(t),function(i,s){r.createAll(e.rest(t),function(e){s?(console.log(s),n(e)):n([i].concat(e))})})},onRequestReceived:function(e,t){this.create({peerId:e},function(e,n){if(n){console.log(n);return}e.onRequestReceived(t)})},onResponseReceived:function(e,t){this.create({peerId:e},function(e,n){if(n){console.log(n);return}e.onResponseReceived(t)})},registerCallback:function(e,t){this._callbacks[e]=t},deregisterCallback:function(t){if(!e.has(this._callbacks,t))return null;var n=this._callbacks[t];return delete this._callbacks[t],n},destroy:function(){this._connectionFactory.destroy()}},o}),n("EntryList",["lodash","ID","Utils"],function(e,t,n){var r=function(){this._entries={}};return r.prototype={addAll:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");e.each(t,function(e){n.add(e)})},add:function(t){if(e.isNull(t))throw new Error("Invalid argument.");e.has(this._entries,t.id.toHexString())?this._entries[t.id.toHexString()].put(t):this._entries[t.id.toHexString()]=new n.Set([t],function(e,t){return e.equals(t)}),n.debug("An entry added (key:",t.id.toHexString(),")")},remove:function(t){if(e.isNull(t))throw new Error("Invalid argument.");if(!e.has(this._entries,t.id.toHexString()))return;this._entries[t.id.toHexString()].remove(t),this._entries[t.id.toHexString()].size()===0&&delete this._entries[t.id.toHexString()],n.debug("An entry removed (key:",t.id.toHexString(),")")},getEntries:function(t){if(e.isNull(t))throw new Error("Invalid argument.");return e.isUndefined(t)?this._entries:e.has(this._entries,t.toHexString())?this._entries[t.toHexString()].items():[]},getEntriesInInterval:function(n,r){if(e.isNull(n)||e.isNull(r))throw new Error("Invalid argument.");var i=[];return e.each(this._entries,function(e,s){t.fromHexString(s).isInInterval(n,r)&&(i=i.concat(e.items()))}),i=i.concat(this.getEntries(r)),i},removeAll:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");e.each(t,function(e){n.remove(e)})},has:function(t){return e.has(this._entries,t.toHexString())},getNumberOfStoredEntries:function(){return e.size(this._entries)},getStatus:function(){return e.chain(this._entries).map(function(t,n){return[n,e.map(t,function(e){return e.value})]}).object().value()},dump:function(){return e.chain(this._entries).map(function(t){return e.invoke(t.items(),"toJson")}).flatten().value()},toString:function(){var n=this;return"[Entries]\n"+e.chain(this._entries).keys().map(function(e){return t.fromHexString(e)}).sort(function(e,t){return e.compareTo(t)}).map(function(t){return"["+t.toHexString()+"]\n"+e.map(n.getEntries(t),function(e){return JSON.stringify(e.value)}).join("\n")+"\n"}).value().join("\n")+"\n"}},r}),n("FingerTable",["lodash"],function(e){var t=function(t,n){if(!t||!n)throw new Error("Invalid arguments.");this._localId=t,this._references=n,this._table=e(this._localId.getLength()).times(function(){return null}).value(),this._powerOfTwos=e(this._localId.getLength()).times(function(e){return t.addPowerOfTwo(e)}).value()};return t.prototype={addReference:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;var t=e.nodeId.getIntervalInPowerOfTwoFrom(this._localId);for(var n=t+1;n<this._table.length;n++)if(!this._table[n])this._table[n]=e;else{if(!e.nodeId.isInInterval(this._table[n].nodeId,this._powerOfTwos[n]))break;var r=this._table[n];this._table[n]=e,this._references.disconnectIfUnreferenced(r)}},getClosestPrecedingNode:function(e){if(!e)throw new Error("Invalid argument.");if(e.equals(this._localId))return null;var t=e.getIntervalInPowerOfTwoFrom(this._localId);return this._table[t]},removeReference:function(e){var t=this;if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;var n=e.nodeId.getIntervalInPowerOfTwoFrom(this._localId),r=this._table[n];for(var i=n+1;i<this._table.length;i++){if(!e.equals(this._table[i]))break;this._table[i]=r}this._references.disconnectIfUnreferenced(e)},getFirstFingerTableEntries:function(t){var n=[];for(var r=0;r<this._table.length;r++){this._table[r]&&(n.length===0||!e.last(n).equals(this._table[r]))&&n.push(this._table[r]);if(n.length>=t)break}return n},containsReference:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return!1;var t=e.nodeId.getIntervalInPowerOfTwoFrom(this._localId);return t===this._table.length-1?!1:e.equals(this._table[t+1])},getStatus:function(){var t=this;return e.map(this._table,function(e){return e?e.toNodeInfo():null})},toString:function(){var t=this;return"[FingerTable]\n"+e.chain(this._table).map(function(e,n){if(!e)return"";if(n===0||n>0&&!e.equals(t._table[n-1]))return"["+n+"] "+e.toString();if(n===t._table.length-1||!e.equals(t._table[n+1]))return"["+n+"]";if(n>1&&e.equals(t._table[n-1])&&!e.equals(t._table[n-2])||n===1&&e.equals(t._table[n-1]))return"...";if(n>1&&e.equals(t._table[n-1])&&e.equals(t._table[n-2]))return"";throw new Error("Unknown situation.")}).reject(function(e){return e===""}).value().join("\n")+"\n"}},t}),n("SuccessorList",["lodash","Utils"],function(e,t){var n=function(e,n,r,i){if(!e||!n||!r)throw new Error("Invalid argument.");t.isPositiveNumber(i.numberOfEntriesInSuccessorList)||(i.numberOfEntriesInSuccessorList=3),this._localId=e,this._capacity=i.numberOfEntriesInSuccessorList,this._entries=n,this._references=r,this._successors=[]};return n.prototype={addSuccessor:function(n){if(!n)throw new Error("Invalid argument.");if(this.containsReference(n))return;if(this._successors.length>=this._capacity&&n.nodeId.isInInterval(e.last(this._successors).nodeId,this._localId))return;var r=!1;for(var i=0;i<this._successors.length;i++)if(n.nodeId.isInInterval(this._localId,this._successors[i].nodeId)){t.insert(this._successors,i,n),r=!0;break}r||(this._successors.push(n),r=!0);var s,o=this._references.getPredecessor();if(o)s=o.nodeId;else{var u=this._references.getClosestPrecedingNode(this._localId);u?s=u.nodeId:s=this._localId}var a=this._localId,f=this._entries.getEntriesInInterval(s,a);n.insertReplicas(f);if(this._successors.length>this._capacity){var l=this._successors.pop();l.removeReplicas(this._localId,[]),this._references.disconnectIfUnreferenced(l)}},getDirectSuccessor:function(){return this._successors.length===0?null:this._successors[0]},getClosestPrecedingNode:function(e){if(!e)throw new Error("Invalid argument.");for(var t=this._successors.length-1;t>=0;t--)if(this._successors[t].nodeId.isInInterval(this._localId,e))return this._successors[t];return null},getReferences:function(){return e.clone(this._successors)},removeReference:function(t){var n=this;if(!t)throw new Error("Invalid argument.");this._successors=e.reject(this._successors,function(e){return e.equals(t)});var r=this._references.getFirstFingerTableEntries(this._capacity);r=e.reject(r,function(e){return e.equals(t)}),e.each(r,function(e){n.addSuccessor(e)})},getSize:function(){return this._successors.length},getCapacity:function(){return this._capacity},containsReference:function(t){if(!t)throw new Error("Invalid argument.");return e.some(this._successors,function(e){return e.equals(t)})},getStatus:function(){return e.invoke(this._successors,"toNodeInfo")},toString:function(){return"[Successors]\n"+e.map(this._successors,function(e,t){return"["+t+"] "+e.toString()}).join("\n")+"\n"}},n}),n("ReferenceList",["lodash","FingerTable","SuccessorList"],function(e,t,n){var r=function(e,r,i){if(!e||!r)throw new Error("Invalid arguments.");this._localId=e,this._fingerTable=new t(e,this),this._successors=new n(e,r,this,i),this._predecessor=null,this._entries=r};return r.prototype={addReference:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;this._fingerTable.addReference(e),this._successors.addSuccessor(e)},removeReference:function(e){if(!e)throw new Error("Invalid argument.");this._fingerTable.removeReference(e),this._successors.removeReference(e),e.equals(this.getPredecessor())&&(this._predecessor=null),this.disconnectIfUnreferenced(e)},getSuccessor:function(){return this._successors.getDirectSuccessor()},getSuccessors:function(){return this._successors.getReferences()},getClosestPrecedingNode:function(t){if(!t)throw new Error("Invalid argument.");if(t.equals(this._localId))return null;var n=[],r=this._fingerTable.getClosestPrecedingNode(t);r&&n.push(r);var i=this._successors.getClosestPrecedingNode(t);return i&&n.push(i),this._predecessor&&t.isInInterval(this._predecessor.nodeId,this._localId)&&n.push(this._predecessor),n.length===0?null:e.chain(n).sort(function(e,n){return t.sub(e.nodeId).compareTo(t.sub(n.nodeId))}).first().value()},getPredecessor:function(){return this._predecessor},addReferenceAsPredecessor:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;(!this._predecessor||e.nodeId.isInInterval(this._predecessor.nodeId,this._localId))&&this._setPredecessor(e),this.addReference(e)},_setPredecessor:function(t){if(!t)throw new Error("Invalid argument.");if(t.nodeId.equals(this._localId))return;if(t.equals(this._predecessor))return;var n=this._predecessor;this._predecessor=t;if(n){this.disconnectIfUnreferenced(n);var r=this._successors.getSize();if(this._successors.getCapacity()===r){var i=e.last(this._successors.getReferences());i.removeReplicas(this._predecessor.nodeId,[])}}else{var s=this._entries.getEntriesInInterval(this._predecessor.nodeId,this._localId),o=this._successors.getReferences();e.each(o,function(e){e.insertReplicas(s)})}},disconnectIfUnreferenced:function(e){if(!e)throw new Error("Invalid argument.");this.containsReference(e)||e.disconnect()},getFirstFingerTableEntries:function(e){return this._fingerTable.getFirstFingerTableEntries(e)},containsReference:function(e){if(!e)throw new Error("Invalid argurment.");return this._fingerTable.containsReference(e)||this._successors.containsReference(e)||e.equals(this._predecessor)},getStatuses:function(){return{successors:this._successors.getStatus(),fingerTable:this._fingerTable.getStatus(),predecessor:this.getPredecessor()?this.getPredecessor().toNodeInfo():null}},toString:function(){return[this._successors.toString(),"[Predecessor]\n"+(this.getPredecessor()?this.getPredecessor().toString():"")+"\n",this._fingerTable.toString()].join("\n")+"\n"}},r}),n("StabilizeTask",["lodash","Utils"],function(e,t){var n=function(e,t,n){this._localNode=e,this._references=t,this._entries=n,this._timer=null};return n.create=function(e,r,i,s){t.isZeroOrPositiveNumber(s.stabilizeTaskInterval)||(s.stabilizeTaskInterval=3e4);var o=new n(e,r,i),u=setInterval(function(){o.run()},s.stabilizeTaskInterval);return o._timer=u,o},n.prototype={run:function(){var n=this,r=this._references.getSuccessors();if(e.isEmpty(r))return;var i=e.first(r);i.notify(this._localNode,function(s,o){if(o){console.log(o),n._references.removeReference(i);return}var u=function(t){e.chain(r).reject(function(r){return r.equals(i)||!e.isNull(n._references.getPredecessor())&&r.equals(n._references.getPredecessor())||e.some(t,function(e){return e.equals(r)})}).each(function(e){n._references.removeReference(e)}),e.each(t,function(e){n._references.addReference(e)});var s=n._references.getSuccessor();s.equals(i)||s.ping(function(e){e&&(console.log(e),n._references.removeReference(s))})};e.size(s)>0&&!e.isNull(s[0])&&(n._localNode.equals(s[0])||i.notifyAndCopyEntries(n._localNode,function(r,i,s){if(s){console.log(s);return}n._entries.addAll(i),u(r),t.debug("[StabilizeTask] successors:",e.map(n._references.getSuccessors(),function(e){return e.getPeerId()}).toString())})),u(s),t.debug("[StabilizeTask] successors:",e.map(n._references.getSuccessors(),function(e){return e.getPeerId()}).toString())})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("FixFingerTask",["lodash","Utils"],function(e,t){var n=function(e,t){this._localNode=e,this._references=t,this._timer=null};return n.create=function(e,r,i){t.isZeroOrPositiveNumber(i.fixFingerTaskInterval)||(i.fixFingerTaskInterval=3e4);var s=new n(e,r),o=setInterval(function(){s.run()},i.fixFingerTaskInterval);return s._timer=o,s},n.prototype={run:function(){var n=this,r=e.random(this._localNode.nodeId.getLength()-1),i=this._localNode.nodeId.addPowerOfTwo(r);this._localNode.findSuccessor(i,function(i,s){if(s){console.log(s);return}!e.isNull(i)&&!n._references.containsReference(i)&&n._references.addReference(i),t.debug("[FixFingerTask] finger:",r,", successor:",i.getPeerId())})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("CheckPredecessorTask",["lodash","Utils"],function(e,t){var n=function(e){this._references=e,this._timer=null};return n.create=function(e,r){t.isZeroOrPositiveNumber(r.checkPredecessorTaskInterval)||(r.checkPredecessorTaskInterval=3e4);var i=new n(e),s=setInterval(function(){i.run()},r.checkPredecessorTaskInterval);return i._timer=s,i},n.prototype={run:function(){var n=this,r=this._references.getPredecessor();if(e.isNull(r))return;r.ping(function(e){if(e){console.log(e),n._references.removeReference(r);return}r=n._references.getPredecessor(),t.debug("[CheckPredecessorTask] predecessor:",r?r.getPeerId():null)})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("LocalNode",["lodash","NodeFactory","EntryList","Entry","ReferenceList","ID","StabilizeTask","FixFingerTask","CheckPredecessorTask","Utils"],function(e,t,n,r,i,s,o,u,a,f){var l=function(e,t){f.isPositiveNumber(t.maximumNumberOfAttemptsOfNotifyAndCopyOnJoin)||(t.maximumNumberOfAttemptsOfNotifyAndCopyOnJoin=5),this._chord=e,this._config=t,this.nodeId=null,this._peerId=null,this._nodeFactory=null,this._tasks={},this._entries=null,this._references=null};return l.create=function(e,n,r){var i=new l(e,n);t.create(i,n,function(e,t,n){if(n){r(null,n);return}i.setup(e,t),r(i)})},l.prototype={setup:function(e,t){this._peerId=e,this.nodeId=s.create(e),this._nodeFactory=t,this._entries=new n,this._references=new i(this.nodeId,this._entries,this._config)},_createTasks:function(){this._tasks={stabilizeTask:o.create(this,this._references,this._entries,this._config),fixFingerTask:u.create(this,this._references,this._config),checkPredecessorTask:a.create(this._references,this._config)},f.debug("Created tasks.")},_shutdownTasks:function(){e.invoke(this._tasks,"shutdown"),f.debug("Shutdown tasks.")},create:function(e){this._createTasks(),f.debug("Created network (peer ID:",this._peerId,")."),e(this._peerId)},join:function(t,n){var r=this;f.debug("Trying to join network."),this._nodeFactory.create({peerId:t},function(t,i){if(i){n(null,i);return}r._references.addReference(t),t.findSuccessor(r.nodeId.addPowerOfTwo(0),function(i,s){if(s){f.debug("[join] Failed to find successor:",s),r._references.removeReference(t),n(null,s);return}f.debug("[join] Found successor:",i.getPeerId()),r._references.addReference(i);var o=function(t,n,s){f.debug("[join] Trying to notify and copy entries (remote peer ID:",t.getPeerId(),", attempts:",n,").");if(n===0){console.log("Reached maximum number of attempts of NOTIFY_AND_COPY."),s([],[]);return}t.notifyAndCopyEntries(r,function(u,a,l){if(l){f.debug("[join] Failed to notify and copy entries (remote peer ID:",t.getPeerId(),")."),s(null,null,l);return}if(e.size(u)===1){f.debug("[join]",i.getPeerId(),"is successor and also predecessor."),r._references.addReferenceAsPredecessor(i),s(u,a);return}if(u[0].equals(r)){f.debug("[join] Left predecessor as null."),s(u,a);return}if(r.nodeId.isInInterval(u[0].nodeId,i.nodeId)){f.debug("[join]",u[0].getPeerId(),"is predecessor."),r._references.addReferenceAsPredecessor(u[0]),s(u,a);return}f.debug("[join] Failed to find predecessor. Retry to notify and copy entries."),r._references.addReference(u[0]),o(u[0],n-1,s)})},u=r._config.maximumNumberOfAttemptsOfNotifyAndCopyOnJoin;o(i,u,function(t,i,s){if(s){console.log("Failed to notify and copy entries:",s),r._createTasks(),n(r._peerId);return}e.each(t,function(t){!e.isNull(t)&&!t.equals(r)&&!r._references.containsReference(t)&&r._references.addReference(t)}),r._entries.addAll(i),e.defer(function(){r._chord.onentriesinserted(e.invoke(i,"toJson"))}),r._createTasks(),f.debug("Joining network succeeded."),n(r._peerId)})})})},leave:function(t){var n=this;this._shutdownTasks();var r=this._references.getSuccessor();!e.isNull(r)&&!e.isNull(this._references.getPredecessor())&&r.leavesNetwork(this._references.getPredecessor()),this._nodeFactory.destroy(),f.debug("Left network."),t()},insert:function(e,t,n){var i;try{i=new r(s.create(e),t)}catch(o){n(null,o);return}this.findSuccessor(i.id,function(e,t){if(t){n(null,t);return}e.insertEntry(i,function(e){if(e){n(null,e);return}n(i.id.toHexString())})})},retrieve:function(t,n){var r;try{r=s.create(t)}catch(i){n(null,i);return}this.findSuccessor(r,function(t,i){if(i){n(null,i);return}t.retrieveEntries(r,function(t,r){if(r){n(null,r);return}n(e.map(t,function(e){return e.value}))})})},remove:function(e,t,n){var i;try{i=new r(s.create(e),t)}catch(o){n(o);return}this.findSuccessor(i.id,function(e,t){if(t){n(t);return}e.removeEntry(i,n)})},getEntries:function(){return this._entries.dump()},setEntries:function(t){this._entries.addAll(e.map(t,function(e){return r.fromJson(e)}))},findSuccessor:function(t,n){var r=this;if(e.isNull(t)){n(null,new Error("Invalid argument."));return}if(!this._references.getPredecessor()||t.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)||t.equals(this.nodeId)){n(this);return}var i=this._references.getClosestPrecedingNode(t);if(!i){var s=this._references.getSuccessor();if(!s){n(this);return}i=s}i.findSuccessor(t,function(e,s){if(s){console.log(s),r._references.removeReference(i),r.findSuccessor(t,n);return}n(e)})},findSuccessorIterative:function(t,n){var r=this;if(e.isNull(t)){n("FAILED",null,new Error("Invalid argument."));return}if(!this._references.getPredecessor()||t.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)||t.equals(this.nodeId)){n("SUCCESS",this);return}var i=this._references.getClosestPrecedingNode(t);if(!i){var s=this._references.getSuccessor();if(!s){n("SUCCESS",this);return}i=s}n("REDIRECT",i)},notifyAndCopyEntries:function(e,t){var n=this,r=this.notify(e,function(r){var i=n._entries.getEntriesInInterval(n.nodeId,e.nodeId);t(r,i)})},notify:function(t,n){var r=[];e.isNull(this._references.getPredecessor())?r.push(t):r.push(this._references.getPredecessor()),r=r.concat(this._references.getSuccessors()),this._references.addReferenceAsPredecessor(t),n(r)},leavesNetwork:function(e){this._references.removeReference(this._references.getPredecessor()),this._references.addReferenceAsPredecessor(e)},insertReplicas:function(t){var n=this;this._entries.addAll(t),e.defer(function(){n._chord.onentriesinserted(e.invoke(t,"toJson"))})},removeReplicas:function(t,n){var r=this;if(e.size(n)!==0){this._entries.removeAll(n),e.defer(function(){r._chord.onentriesremoved(e.invoke(n,"toJson"))});return}var i=this._entries.getEntriesInInterval(this.nodeId,t);this._entries.removeAll(i),e.defer(function(){r._chord.onentriesremoved(e.invoke(i,"toJson"))})},insertEntry:function(e,t){this.insertEntryIterative(e,function(n,r){n==="SUCCESS"?t():n==="REDIRECT"?r.insertEntry(e,t):t(new Error("Got unknown status:",n))})},insertEntryIterative:function(t,n){var r=this;if(this._references.getPredecessor()&&!t.id.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)&&!t.id.equals(this.nodeId)){n("REDIRECT",this._references.getPredecessor());return}this._entries.add(t),e.defer(function(){r._chord.onentriesinserted([t.toJson()])}),e.each(this._references.getSuccessors(),function(e){e.insertReplicas([t])}),n("SUCCESS")},retrieveEntries:function(e,t){this.retrieveEntriesIterative(e,function(n,r,i){n==="SUCCESS"?t(r):n==="REDIRECT"?i.retrieveEntries(e,t):t(null,new Error("Got unknown status:",n))})},retrieveEntriesIterative:function(e,t){if(this._entries.has(e)){t("SUCCESS",this._entries.getEntries(e));return}if(this._references.getPredecessor()&&!e.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)&&!e.equals(this.nodeId)){t("REDIRECT",null,this._references.getPredecessor());return}t("SUCCESS",this._entries.getEntries(e))},removeEntry:function(e,t){this.removeEntryIterative(e,function(n,r){n==="SUCCESS"?t():n==="REDIRECT"?r.removeEntry(e,t):t(new Error("Got unknown status:",n))})},removeEntryIterative:function(t,n){var r=this;if(this._references.getPredecessor()&&!t.id.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)&&!t.id.equals(this.nodeId)){n("REDIRECT",this._references.getPredecessor());return}this._entries.remove(t),e.defer(function(){r._chord.onentriesremoved([t.toJson()])}),e.each(this._references.getSuccessors(),function(e){e.removeReplicas(r.nodeId,[t])}),n("SUCCESS")},getStatuses:function(){var e=this._references.getStatuses();return e.entries=this._entries.getStatus(),e},getPeerId:function(){return this._peerId},toNodeInfo:function(){return{nodeId:this.nodeId.toHexString(),peerId:this._peerId}},equals:function(t){return e.isNull(t)?!1:this.nodeId.equals(t.nodeId)},toString:function(){return this.nodeId.toHexString()+" ("+this._peerId+")"},toDisplayString:function(){return[this._references.toString(),this._entries.toString()].join("\n")+"\n"}},l}),n("Chord",["lodash","LocalNode","Utils"],function(e,t,n){var r=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");n.enableDebugLog(t.debug),this.version=n.version.join("."),this._config=t,this._localNode=null,this.onentriesinserted=function(e){},this.onentriesremoved=function(e){}};return r.prototype={create:function(e){var n=this;if(this._localNode)throw new Error("Local node is already created.");e||(e=function(){}),t.create(this,this._config,function(t,r){if(r){e(null,r);return}n._localNode=t,n._localNode.create(function(t,r){r&&(n.leave(),n._localNode=null),e(t,r)})})},join:function(e,r){var i=this;if(!n.isNonemptyString(e))throw new Error("Invalid argument.");if(this._localNode)throw new Error("Local node is already created.");r||(r=function(){}),t.create(this,this._config,function(t,n){if(n){r(null,n);return}i._localNode=t,i._localNode.join(e,function(e,t){t&&(i.leave(),i._localNode=null),r(e,t)})})},leave:function(){var e=this;if(!this._localNode)return;this._localNode.leave(function(){e._localNode=null})},insert:function(t,r,i){i||(i=function(){});if(!this._localNode){i(null,new Error("Create or join network at first."));return}if(!n.isNonemptyString(t)||e.isUndefined(r)){i(null,new Error("Invalid arguments."));return}this._localNode.insert(t,r,i)},retrieve:function(e,t){t||(t=function(){});if(!this._localNode){t(null,new Error("Create or join network at first."));return}if(!n.isNonemptyString(e)){t(null,new Error("Invalid argument."));return}this._localNode.retrieve(e,t)},remove:function(t,r,i){i||(i=function(){});if(!this._localNode){i(new Error("Create or join network at first."));return}if(!n.isNonemptyString(t)||e.isUndefined(r)){i(new Error("Invalid arguments."));return}this._localNode.remove(t,r,i)},getEntries:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getEntries()},setEntries:function(e){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.setEntries(e)},getStatuses:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getStatuses()},getPeerId:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getPeerId()},getNodeId:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.nodeId.toHexString()},toString:function(){return this._localNode?this._localNode.toDisplayString():""}},r}),t("Chord")});